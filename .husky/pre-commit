#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook to run linting and formatting

echo "üîç Running pre-commit checks..."

# Check if files are staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No staged files to check"
  exit 0
fi

# Stash unstaged changes
echo "üì¶ Stashing unstaged changes..."
git stash -q --keep-index

# Function to restore unstaged changes and exit
restore_and_exit() {
  echo "üì¶ Restoring unstaged changes..."
  git stash pop -q
  exit $1
}

# Run PHP linting
PHP_FILES=$(echo "$STAGED_FILES" | grep '\.php$')
if [ -n "$PHP_FILES" ]; then
  echo "üîç Checking PHP files with Laravel Pint..."
  
  if ! ./vendor/bin/pint --test $PHP_FILES; then
    echo "‚ùå PHP formatting issues found. Run 'composer pint' to fix."
    restore_and_exit 1
  fi
  
  echo "‚úÖ PHP files pass linting"
fi

# Run JavaScript/Vue linting
JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|ts|vue)$')
if [ -n "$JS_FILES" ]; then
  echo "üîç Checking JavaScript/Vue files with ESLint..."
  
  if ! npm run lint:js -- --max-warnings=0; then
    echo "‚ùå JavaScript linting issues found. Run 'npm run lint:fix' to fix."
    restore_and_exit 1
  fi
  
  echo "‚úÖ JavaScript/Vue files pass linting"
fi

# Run CSS linting
CSS_FILES=$(echo "$STAGED_FILES" | grep '\.css$')
if [ -n "$CSS_FILES" ]; then
  echo "üîç Checking CSS files with Stylelint..."
  
  if ! npm run lint:css; then
    echo "‚ùå CSS linting issues found. Run 'npm run lint:fix' to fix."
    restore_and_exit 1
  fi
  
  echo "‚úÖ CSS files pass linting"
fi

# Check for debug statements
echo "üîç Checking for debug statements..."
DEBUG_PATTERNS="dd\(|dump\(|var_dump\(|console\.log\(|debugger"
DEBUG_FILES=$(echo "$STAGED_FILES" | xargs grep -lE "$DEBUG_PATTERNS" 2>/dev/null)

if [ -n "$DEBUG_FILES" ]; then
  echo "‚ùå Debug statements found in:"
  echo "$DEBUG_FILES"
  echo "Please remove debug statements before committing."
  restore_and_exit 1
fi

echo "‚úÖ No debug statements found"

# Check for merge conflict markers
echo "üîç Checking for merge conflict markers..."
CONFLICT_MARKERS="<<<<<<<|=======|>>>>>>>"
CONFLICT_FILES=$(echo "$STAGED_FILES" | xargs grep -lE "$CONFLICT_MARKERS" 2>/dev/null)

if [ -n "$CONFLICT_FILES" ]; then
  echo "‚ùå Merge conflict markers found in:"
  echo "$CONFLICT_FILES"
  echo "Please resolve conflicts before committing."
  restore_and_exit 1
fi

echo "‚úÖ No merge conflict markers found"

# Check for large files (>5MB)
echo "üîç Checking for large files..."
LARGE_FILES=$(echo "$STAGED_FILES" | while read file; do
  if [ -f "$file" ]; then
    size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
    if [ $size -gt 5242880 ]; then
      echo "$file ($(numfmt --to=iec-i --suffix=B $size))"
    fi
  fi
done)

if [ -n "$LARGE_FILES" ]; then
  echo "‚ö†Ô∏è  Large files detected (>5MB):"
  echo "$LARGE_FILES"
  echo "Consider using Git LFS or excluding from repository."
  # This is a warning, not a blocker
fi

# Restore unstaged changes
restore_and_exit 0
